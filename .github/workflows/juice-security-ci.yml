name: Juice Shop Security CI - DevSecOps Thesis

on:
  push:
    branches: [ master ]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  # 1) 빌드 + 기본 테스트
  build-and-test:
    name: Build & Test (Node)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      # 선택사항: 기본 테스트
      - name: Run unit tests (optional)
        run: |
          npm test --if-present || echo "Tests failed or not defined, continue for security scans"

  # 2) SAST - SonarCloud (Juice Shop용)
  sast-sonarcloud:
    name: SAST - SonarCloud (Juice Shop)
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        with:
          projectBaseDir: .
          args: >
            -Dsonar.projectKey=Jiyoung0716_juice-shop-thesis
            -Dsonar.organization=jiyoung0716

      - name: Export SonarCloud JSON report
        run: |
          curl -u "${{ secrets.SONAR_TOKEN }}:" \
            "https://sonarcloud.io/api/issues/search?componentKeys=Jiyoung0716_juice-shop-thesis" \
            -o sonarcloud.json

      - name: Upload SonarCloud JSON
        uses: actions/upload-artifact@v4
        with:
          name: sonarcloud-report
          path: sonarcloud.json

  # 3) DAST - OWASP ZAP (localhost:3000에서 실행 중인 Juice Shop 대상으로)
  dast-zap:
    name: DAST - OWASP ZAP (Juice Shop)
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Start Juice Shop
        run: |
          npm start &
          # 앱이 뜰 때까지 대기 (최대 60초 정도)
          for i in $(seq 1 30); do
            if curl -sSf http://localhost:3000/ >/dev/null; then
              echo "Juice Shop is up"
              break
            fi
            echo "Waiting for Juice Shop..."
            sleep 2
          done

      - name: ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.12.0
        continue-on-error: true
        with:
          target: 'http://localhost:3000'
          fail_action: false
          allow_issue_writing: false
          artifact_name: ''
      - name: Upload ZAP reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: |
            report_html.html
            report_json.json
            report_md.md

  # 4) Metrics Aggregator (Juice Shop에는 tfsec 없음 → SAST + ZAP만)
  metrics-aggregator:
    name: Metrics Aggregator (Juice Shop)
    runs-on: ubuntu-latest
    needs: [sast-sonarcloud, dast-zap]
    steps:
      - uses: actions/checkout@v4

      - name: Download all reports artifacts
        uses: actions/download-artifact@v4
        with:
          path: reports

      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install analysis dependencies
        run: |
          python -m pip install --upgrade pip
          pip install matplotlib pandas

      - name: Run metrics & graph generator
        run: |
          python3 analyze_security.py

      - name: Upload metrics artifacts
        uses: actions/upload-artifact@v4
        with:
          name: metrics-report
          path: metrics_output

  # 5) Quality Gate (Juice Shop용도 동일 로직 재사용)
  quality-gate:
    name: Quality Gate (Juice Shop)
    runs-on: ubuntu-latest
    needs: metrics-aggregator
    steps:
      - uses: actions/checkout@v4

      - name: Download metrics artifact
        uses: actions/download-artifact@v4
        with:
          name: metrics-report
          path: metrics_output

      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Run Quality Gate Check
        run: |
          python3 quality_gate.py
